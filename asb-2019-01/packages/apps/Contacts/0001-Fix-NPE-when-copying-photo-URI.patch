From 075c00042dad94f921d35f75c0a17b06df3b8c8a Mon Sep 17 00:00:00 2001
From: Jay Shrauner <shrauner@google.com>
Date: Fri, 27 Feb 2015 15:47:09 -0800
Subject: [PATCH 1/3] Fix NPE when copying photo URI

Bug:19564741
Change-Id: I0a4e0ccf2a917d403d1411fc737da293c81aded0
---
 src/com/android/contacts/activities/AttachPhotoActivity.java | 5 ++++-
 src/com/android/contacts/detail/PhotoSelectionHandler.java   | 6 ++++--
 src/com/android/contacts/util/ContactPhotoUtils.java         | 3 +++
 3 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/com/android/contacts/activities/AttachPhotoActivity.java b/src/com/android/contacts/activities/AttachPhotoActivity.java
index f70bc7e..841f21c 100644
--- a/src/com/android/contacts/activities/AttachPhotoActivity.java
+++ b/src/com/android/contacts/activities/AttachPhotoActivity.java
@@ -142,7 +142,10 @@ public class AttachPhotoActivity extends ContactsActivity {
             // we can add the FLAG_GRANT_WRITE_URI_PERMISSION flag to the eventual
             // crop intent for read-only URI's.
             // TODO: With b/10837468 fixed should be able to avoid this copy.
-            ContactPhotoUtils.savePhotoFromUriToUri(this, inputUri, mTempPhotoUri, false);
+            if (!ContactPhotoUtils.savePhotoFromUriToUri(this, inputUri, mTempPhotoUri, false)) {
+                finish();
+                return;
+            }
             toCrop = mTempPhotoUri;
 
             final Intent intent = new Intent("com.android.camera.action.CROP", toCrop);
diff --git a/src/com/android/contacts/detail/PhotoSelectionHandler.java b/src/com/android/contacts/detail/PhotoSelectionHandler.java
index d2363de..49445a9 100644
--- a/src/com/android/contacts/detail/PhotoSelectionHandler.java
+++ b/src/com/android/contacts/detail/PhotoSelectionHandler.java
@@ -161,8 +161,10 @@ public abstract class PhotoSelectionHandler implements OnClickListener {
                     } else {
                         toCrop = mTempPhotoUri;
                         try {
-                            ContactPhotoUtils.savePhotoFromUriToUri(mContext, uri,
-                                    toCrop, false);
+                            if (!ContactPhotoUtils.savePhotoFromUriToUri(mContext, uri,
+                                            toCrop, false)) {
+                                return false;
+                            }
                         } catch (SecurityException e) {
                             Log.d(TAG, "Did not have read-access to uri : " + uri);
                             return false;
diff --git a/src/com/android/contacts/util/ContactPhotoUtils.java b/src/com/android/contacts/util/ContactPhotoUtils.java
index 2b1c19a..875b8cc 100644
--- a/src/com/android/contacts/util/ContactPhotoUtils.java
+++ b/src/com/android/contacts/util/ContactPhotoUtils.java
@@ -145,6 +145,9 @@ public class ContactPhotoUtils {
      */
     public static boolean savePhotoFromUriToUri(Context context, Uri inputUri, Uri outputUri,
             boolean deleteAfterSave) {
+        if (inputUri == null || outputUri == null) {
+            return false;
+        }
         FileOutputStream outputStream = null;
         InputStream inputStream = null;
         try {
-- 
2.7.4

