From b91ff2faef74715ada137567797b283ed6671270 Mon Sep 17 00:00:00 2001
From: Hansong Zhang <hsz@google.com>
Date: Tue, 29 May 2018 17:38:39 -0700
Subject: [PATCH 1/9] DO NOT MERGE SMP: Check p_cb->role in
 smp_br_state_machine_event

Bug: 80145946
Test: manual
Change-Id: Ic83eaa4be868d5a345d80cd50a6915c0af719a53
(cherry picked from commit 519b61392a96fbd45bdcc0bfddc881167c20cc23)
---
 stack/smp/smp_main.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/stack/smp/smp_main.c b/stack/smp/smp_main.c
index 1fa64ce..2751c17 100644
--- a/stack/smp/smp_main.c
+++ b/stack/smp/smp_main.c
@@ -449,6 +449,12 @@ void smp_sm_event(tSMP_CB *p_cb, tSMP_EVENT event, void *p_data)
         return;
     }
 
+    if (p_cb->role > 0x01) {
+      SMP_TRACE_ERROR2("%s: invalid role %d", __func__, p_cb->role);
+      android_errorWriteLog(0x534e4554, "80145946");
+      return;
+    }
+
     SMP_TRACE_DEBUG5( "SMP Role: %s State: [%s (%d)], Event: [%s (%d)]",\
                       (p_cb->role == 0x01) ?"Slave" : "Master", smp_get_state_name( p_cb->state),
                       p_cb->state, smp_get_event_name(event), event) ;
-- 
2.7.4

