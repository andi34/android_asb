From 7b976ba2edfd742aaaa9fb5774b000900f419ef5 Mon Sep 17 00:00:00 2001
From: Kenny Root <kroot@google.com>
Date: Mon, 14 Mar 2016 14:30:42 -0700
Subject: [PATCH 06/16] Fix double-free in DSA code (CVE-2016-0705)

Bug: 27449871
Change-Id: I9a2fa73560b06c4652897c029c1177b1d2736bae
(cherry picked from commit 000d9d2580fe6e1c1a8566ae6d869304b4d29e8b)
---
 crypto/dsa/dsa_ameth.c             | 21 +++++++++----------
 openssl.config                     |  1 +
 patches/0019-dsa_double_free.patch | 43 ++++++++++++++++++++++++++++++++++++++
 3 files changed, 54 insertions(+), 11 deletions(-)
 create mode 100644 patches/0019-dsa_double_free.patch

diff --git a/crypto/dsa/dsa_ameth.c b/crypto/dsa/dsa_ameth.c
index 376156e..4f82d58 100644
--- a/crypto/dsa/dsa_ameth.c
+++ b/crypto/dsa/dsa_ameth.c
@@ -201,6 +201,8 @@ static int dsa_priv_decode(EVP_PKEY *pkey, PKCS8_PRIV_KEY_INFO *p8)
 	STACK_OF(ASN1_TYPE) *ndsa = NULL;
 	DSA *dsa = NULL;
 
+	int ret = 0;
+
 	if (!PKCS8_pkey_get0(NULL, &p, &pklen, &palg, p8))
 		return 0;
 	X509_ALGOR_get0(NULL, &ptype, &pval, palg);
@@ -281,23 +283,20 @@ static int dsa_priv_decode(EVP_PKEY *pkey, PKCS8_PRIV_KEY_INFO *p8)
 		}
 
 	EVP_PKEY_assign_DSA(pkey, dsa);
-	BN_CTX_free (ctx);
-	if(ndsa)
-		sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
-	else
-		ASN1_INTEGER_free(privkey);
-
-	return 1;
+	ret = 1;
+	goto done;
 
 	decerr:
 	DSAerr(DSA_F_DSA_PRIV_DECODE, EVP_R_DECODE_ERROR);
 	dsaerr:
+	DSA_free(dsa);
+	done:
 	BN_CTX_free (ctx);
-	if (privkey)
+	if (ndsa)
+		sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
+	else
 		ASN1_INTEGER_free(privkey);
-	sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
-	DSA_free(dsa);
-	return 0;
+	return ret;
 	}
 
 static int dsa_priv_encode(PKCS8_PRIV_KEY_INFO *p8, const EVP_PKEY *pkey)
diff --git a/openssl.config b/openssl.config
index 06f3b89..d85daae 100644
--- a/openssl.config
+++ b/openssl.config
@@ -995,6 +995,7 @@ tls12_digests.patch \
 alpn.patch \
 early_ccs.patch \
 0018-tls_fallback_scsv.patch \
+0019-dsa_double_free.patch \
 "
 
 OPENSSL_PATCHES_progs_SOURCES="\
diff --git a/patches/0019-dsa_double_free.patch b/patches/0019-dsa_double_free.patch
new file mode 100644
index 0000000..a5b01e7
--- /dev/null
+++ b/patches/0019-dsa_double_free.patch
@@ -0,0 +1,43 @@
+--- openssl-1.0.1e.orig/crypto/dsa/dsa_ameth.c	2016-03-14 14:28:34.995124120 -0700
++++ openssl-1.0.1e/crypto/dsa/dsa_ameth.c	2016-03-14 14:29:23.070940703 -0700
+@@ -201,6 +201,8 @@
+ 	STACK_OF(ASN1_TYPE) *ndsa = NULL;
+ 	DSA *dsa = NULL;
+ 
++	int ret = 0;
++
+ 	if (!PKCS8_pkey_get0(NULL, &p, &pklen, &palg, p8))
+ 		return 0;
+ 	X509_ALGOR_get0(NULL, &ptype, &pval, palg);
+@@ -281,23 +283,20 @@
+ 		}
+ 
+ 	EVP_PKEY_assign_DSA(pkey, dsa);
+-	BN_CTX_free (ctx);
+-	if(ndsa)
+-		sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
+-	else
+-		ASN1_INTEGER_free(privkey);
+-
+-	return 1;
++	ret = 1;
++	goto done;
+ 
+ 	decerr:
+ 	DSAerr(DSA_F_DSA_PRIV_DECODE, EVP_R_DECODE_ERROR);
+ 	dsaerr:
++	DSA_free(dsa);
++	done:
+ 	BN_CTX_free (ctx);
+-	if (privkey)
++	if (ndsa)
++		sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
++	else
+ 		ASN1_INTEGER_free(privkey);
+-	sk_ASN1_TYPE_pop_free(ndsa, ASN1_TYPE_free);
+-	DSA_free(dsa);
+-	return 0;
++	return ret;
+ 	}
+ 
+ static int dsa_priv_encode(PKCS8_PRIV_KEY_INFO *p8, const EVP_PKEY *pkey)
-- 
2.7.4

