From 2a9b27cfbafca809fe0401d22a876e62f1729857 Mon Sep 17 00:00:00 2001
From: Hansong Zhang <hsz@google.com>
Date: Mon, 2 Apr 2018 10:05:56 -0700
Subject: [PATCH 1/5] DO NOT MERGE Fix unexpected behavior in bta_dm_sdp_result

Check the number of UUIDs from remote device

Bug: 74016921
Test: manual
Change-Id: I1ca1f66bfc935f5fd219e8147511bdac7d2789ef
(cherry picked from commit 67ec216daa43f71adf103de6c4156c5a892c1460)
CVE-2018-9355
---
 bta/dm/bta_dm_act.c | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/bta/dm/bta_dm_act.c b/bta/dm/bta_dm_act.c
index 36d7082..1925a4b 100755
--- a/bta/dm/bta_dm_act.c
+++ b/bta/dm/bta_dm_act.c
@@ -37,6 +37,7 @@
 #include "l2c_api.h"
 #include "wbt_api.h"
 #include "utl.h"
+#include <cutils/log.h>
 #include <string.h>
 
 static void bta_dm_inq_results_cb (tBTM_INQ_RESULTS *p_inq, UINT8 *p_eir);
@@ -73,6 +74,8 @@ static void bta_dm_eir_search_services( tBTM_INQ_RESULTS  *p_result,
                                         tBTA_SERVICE_MASK *p_services_found);
 #endif /* BTM_EIR_CLIENT_INCLUDED */
 
+#define BTA_MAX_SERVICES 32
+
 static void bta_dm_rssi_cback (tBTM_RSSI_RESULTS *p_result);
 static void bta_dm_signal_strength_timer_cback (TIMER_LIST_ENT *p_tle);
 static void bta_dm_link_quality_cback (tBTM_LINK_QUALITY_RESULTS *p_result);
@@ -1641,7 +1644,7 @@ void bta_dm_sdp_result (tBTA_DM_MSG *p_data)
 #endif
 
     UINT32 num_uuids = 0;
-    UINT8  uuid_list[32][MAX_UUID_SIZE]; // assuming a max of 32 services
+    UINT8  uuid_list[BTA_MAX_SERVICES][MAX_UUID_SIZE]; // assuming a max of 32 services
 
     if((p_data->sdp_event.sdp_result == SDP_SUCCESS)
         || (p_data->sdp_event.sdp_result == SDP_NO_RECS_MATCH)
@@ -1737,8 +1740,12 @@ void bta_dm_sdp_result (tBTA_DM_MSG *p_data)
                         (tBTA_SERVICE_MASK)(BTA_SERVICE_ID_TO_SERVICE_MASK(bta_dm_search_cb.service_index-1));
                     tmp_svc = bta_service_id_to_uuid_lkup_tbl[bta_dm_search_cb.service_index-1];
                     /* Add to the list of UUIDs */
-                    sdpu_uuid16_to_uuid128(tmp_svc, uuid_list[num_uuids]);
-                    num_uuids++;
+                    if (num_uuids < BTA_MAX_SERVICES) {
+                      sdpu_uuid16_to_uuid128(tmp_svc, uuid_list[num_uuids]);
+                      num_uuids++;
+                    } else {
+                      android_errorWriteLog(0x534e4554, "74016921");
+                    }
                 }
             }
             }
@@ -1779,8 +1786,12 @@ void bta_dm_sdp_result (tBTA_DM_MSG *p_data)
                 {
                     if (SDP_FindServiceUUIDInRec_128bit(p_sdp_rec, &temp_uuid))
                     {
+                      if (num_uuids < BTA_MAX_SERVICES) {
                         memcpy(uuid_list[num_uuids], temp_uuid.uu.uuid128, MAX_UUID_SIZE);
                         num_uuids++;
+                      } else {
+                        android_errorWriteLog(0x534e4554, "74016921");
+                      }
                     }
                 }
             } while (p_sdp_rec);
-- 
2.7.4

