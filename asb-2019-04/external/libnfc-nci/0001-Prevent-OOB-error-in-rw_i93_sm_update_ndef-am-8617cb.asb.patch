From c8399eed05bebe817a007599b50096028fd4e526 Mon Sep 17 00:00:00 2001
From: Jack Yu <jackcwyu@google.com>
Date: Fri, 1 Feb 2019 15:48:03 -0800
Subject: [PATCH 1/5] Prevent OOB error in rw_i93_sm_update_ndef() am:
 8617cbb1a8 am: 8081839dc8 am: c80b838093

Change-Id: I8a102085d7ecfeb977d742ebc742e364752cc1b8
(cherry picked from commit c23e375317d638701d1f0c289c85b153ec461082)
---
 src/nfc/tags/rw_i93.c | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/src/nfc/tags/rw_i93.c b/src/nfc/tags/rw_i93.c
index 320235e..e5eef76 100644
--- a/src/nfc/tags/rw_i93.c
+++ b/src/nfc/tags/rw_i93.c
@@ -1506,6 +1506,13 @@ void rw_i93_sm_detect_ndef (BT_HDR *p_resp)
     RW_TRACE_DEBUG1 ("rw_i93_sm_detect_ndef () sub_state:0x%x", p_i93->sub_state);
 #endif
 
+    if (length == 0 || p_i93->block_size > I93_MAX_BLOCK_LENGH)
+    {
+        android_errorWriteLog(0x534e4554, "122320256");
+        rw_i93_handle_error(NFC_STATUS_FAILED);
+        return;
+    }
+
     STREAM_TO_UINT8 (flags, p);
     length--;
 
@@ -2088,6 +2095,13 @@ void rw_i93_sm_update_ndef (BT_HDR *p_resp)
         /* get offset of length field */
         length_offset = (p_i93->ndef_tlv_start_offset + 1) % p_i93->block_size;
 
+        if (length < length_offset)
+        {
+            android_errorWriteLog(0x534e4554, "122320256");
+            rw_i93_handle_error(NFC_STATUS_FAILED);
+            return;
+        }
+
         /* set length to zero */
         *(p + length_offset) = 0x00;
 
@@ -2106,6 +2120,12 @@ void rw_i93_sm_update_ndef (BT_HDR *p_resp)
             /* write the first part of NDEF in the same block */
             for ( ; xx < p_i93->block_size; xx++)
             {
+                if (xx > length || p_i93->rw_length > p_i93->ndef_length)
+                {
+                    android_errorWriteLog(0x534e4554, "122320256");
+                    rw_i93_handle_error(NFC_STATUS_FAILED);
+                    return;
+                }
                 if (p_i93->rw_length < p_i93->ndef_length)
                 {
                     *(p + xx) = *(p_i93->p_update_data + p_i93->rw_length++);
@@ -2281,6 +2301,13 @@ void rw_i93_sm_update_ndef (BT_HDR *p_resp)
                 /* update length field within the read block */
                 for (xx = length_offset; xx < p_i93->block_size; xx++)
                 {
+                    if (xx > length)
+                    {
+                        android_errorWriteLog(0x534e4554, "122320256");
+                        rw_i93_handle_error(NFC_STATUS_FAILED);
+                        return;
+                    }
+
                     if (p_i93->rw_length == 3)
                         *(p + xx) = 0xFF;
                     else if (p_i93->rw_length == 2)
-- 
2.7.4

